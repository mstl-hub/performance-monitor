# Описание протокола SKOV Main IO CANopen

**Версия документа:** 1.0  
**Дата:** 2025-11-12  
**Устройство:** SKOV Main IO (Код продукта: SKOV_Main_Io)  
**Производитель:** SKOV A/S (ID производителя: 1116)  
**Протокол:** CANopen CiA 301  
**Версия EDS:** 5.0

---

## Оглавление

1. [Обзор](#обзор)
2. [Идентификация устройства](#идентификация-устройства)
3. [Словарь объектов](#словарь-объектов)
4. [Коммуникация PDO](#коммуникация-pdo)
5. [Протокол аналоговых входов](#протокол-аналоговых-входов)
6. [Протокол цифровых входов-выходов](#протокол-цифровых-входов-выходов)
7. [Протокол датчика DOL12](#протокол-датчика-dol12)
8. [Протокол модуля DOL78](#протокол-модуля-dol78)
9. [Последовательность инициализации](#последовательность-инициализации)
10. [Кодирование данных](#кодирование-данных)
11. [Примеры](#примеры)

---

## Обзор

### Назначение устройства

SKOV Main IO — это CANopen модуль ввода-вывода, предназначенный для приложений управления климатом в сельскохозяйственных зданиях (птичники, свинофермы и т.д.). Он обеспечивает:

- **Аналоговые входы:** 7-11 настраиваемых входов (16-битное разрешение)
- **Аналоговые выходы:** 2-6 выходов (16-битное разрешение)
- **Цифровые входы:** 12 входов со счетчиком импульсов
- **Цифровые выходы:** 12 реле + 1 аварийное реле
- **Выходы TRIAC:** 2 канала для управления мощностью переменного тока
- **Температурные датчики:** Поддержка датчиков SKOV DOL12
- **Диагностический мониторинг:** Внутренняя температура, напряжения, статус калибровки

### Основные характеристики

| Характеристика | Спецификация |
|---|---|
| **Профиль CANopen** | CiA 301 Device Profile |
| **Скорость передачи** | 125 кбит/с |
| **Диапазон ID узла** | 1-127 (настраивается) |
| **Количество PDO** | 9 TPDO, 4 RPDO |
| **SDO каналы** | 1 сервер |
| **Поддержка NMT** | Полная машина состояний |
| **Heartbeat** | Поддерживается (производитель/потребитель) |
| **Guard Time** | Поддерживается |
| **Emergency** | Поддерживается |

---

## Идентификация устройства

### Обязательные объекты идентификации

| Индекс | Sub | Параметр | Тип | Значение | Описание |
|---|---|---|---|---|---|
| 0x1000 | - | Тип устройства | UNSIGNED32 | 0x000E0191 | Классификация устройства |
| 0x1001 | - | Регистр ошибок | UNSIGNED8 | - | Текущий статус ошибки |
| 0x1018 | 0 | Объект идентификации | UNSIGNED8 | 4 | Количество записей |
| 0x1018 | 1 | ID производителя | UNSIGNED32 | 1116 | SKOV A/S |
| 0x1018 | 2 | Код продукта | UNSIGNED32 | - | Идентификатор продукта |
| 0x1018 | 3 | Номер редакции | UNSIGNED32 | - | Редакция оборудования (напр., 29) |
| 0x1018 | 4 | Серийный номер | UNSIGNED32 | - | Уникальный серийный номер (напр., 100412420) |

### Необязательные объекты идентификации

| Индекс | Параметр | Тип | Пример значения | Описание |
|---|---|---|---|---|
| 0x1008 | Имя устройства производителя | STRING | "SM00" | Код модели |
| 0x1009 | Версия оборудования производителя | STRING | "1" | Строка версии оборудования |
| 0x100A | Версия программного обеспечения производителя | STRING | "5202" | Версия микропрограммы |

**Примечание:** Формат серийного номера обычно отображается как `{Серийный_номер}-{Номер_редакции}` (напр., "100412420-29")

---

## Словарь объектов

### Объекты профиля коммуникации (0x1000-0x1FFF)

#### Управление сетью (NMT)

| Индекс | Sub | Параметр | Тип | Доступ | По умолчанию | Описание |
|---|---|---|---|---|---|---|
| 0x100C | - | Guard Time | UNSIGNED16 | RW | 0 | Время guard в мс |
| 0x100D | - | Life Time Factor | UNSIGNED8 | RW | 0 | Множитель для guard time |

**Расчет Guard Time:** `Timeout = Guard_Time × Life_Time_Factor`

Пример: Guard Time = 1000 мс, Life Time Factor = 5 → Timeout = 5000 мс

#### Emergency (EMCY)

| Индекс | Sub | Параметр | Тип | Доступ | По умолчанию | Описание |
|---|---|---|---|---|---|---|
| 0x1014 | - | COB-ID EMCY | UNSIGNED32 | RW | 0x80 + NodeID | ID сообщения об ошибке |
| 0x1015 | - | Inhibit Time Emergency | UNSIGNED16 | RW | 0 | Мин. время между EMCY (×100мкс) |
| 0x1029 | 1 | Communication Error | UNSIGNED8 | RW | 0 | Поведение при потере связи |

#### Конфигурация PDO

**Receive PDO (RPDO) - Объекты управления**

| Индекс | Имя | Формула COB-ID | Сопоставленные объекты | Назначение |
|---|---|---|---|---|
| 0x1400 | RPDO 0 | 0x200 + NodeID | 0x6300 | Управление реле |
| 0x1401 | RPDO 1 | 0x300 + NodeID | 0x6411:01-02 | Аналоговые выходы 1-2 |
| 0x1402 | RPDO 2 | 0x400 + NodeID | 0x6411:03-06 | Аналоговые выходы 3-6 |
| 0x1403 | RPDO 3 | 0x500 + NodeID | 0x2302:01-02 | Управление TRIAC 1-2 |

**Transmit PDO (TPDO) - Объекты статуса**

| Индекс | Имя | Формула COB-ID | Сопоставленные объекты | Назначение | Типичный период |
|---|---|---|---|---|---|
| 0x1800 | TPDO 0 | 0x180 + NodeID | 0x6100:01 | Цифровые входы | По событию |
| 0x1801 | TPDO 1 | 0x280 + NodeID | 0x6401:01-04 | Аналоговые входы 1-4 | 500 мс |
| 0x1802 | TPDO 2 | 0x380 + NodeID | 0x6401:05-07 | Аналоговые входы 5-7 | 500 мс |
| 0x1803 | TPDO 3 | 0x480 + NodeID | 0x6401:08-11 | Аналоговые входы 8-11 | 500 мс |
| 0x1804 | TPDO 4 | 0x190 + NodeID | 0x2300:01-03 | Статус DOL78 | При изменении |
| 0x1805 | TPDO 5 | 0x290 + NodeID | 0x2301:01-04 | Диагностика | 15 с |
| 0x1806 | TPDO 6 | 0x390 + NodeID | 0x6100:02-05 | Счетчики 1-4 | При изменении |
| 0x1807 | TPDO 7 | 0x490 + NodeID | 0x6100:06-08 | Счетчики 5-7 | При изменении |
| 0x1808 | TPDO 8 | 0x1A0 + NodeID | 0x6100:09-12 | Счетчики 8-11 | При изменении |

**Параметры PDO:**

Каждое PDO имеет следующие подиндексы:
- **Sub 0:** Наибольший поддерживаемый подиндекс
- **Sub 1:** COB-ID (бит 31 = валиден/инвалиден)
- **Sub 2:** Тип передачи (255 = по событию, 1-240 = циклический)
- **Sub 3:** Время ингибирования (мин. время между передачами в ×100мкс)
- **Sub 5:** Таймер события (период циклической передачи в мс, 0 = отключено)

---

### Объекты, специфичные для производителя (0x2000-0x2FFF)

#### 0x2011 - Уровень ошибок CAN

| Sub | Параметр | Тип | Доступ | Описание |
|---|---|---|---|---|
| 0 | CAN Error Level | UNSIGNED8 | RW | Статус ошибок шины CAN (0=ОК, 1=предупреждение, 2=ошибка) |

#### 0x2101 - Информация загрузчика

| Sub | Параметр | Тип | Доступ | Описание |
|---|---|---|---|---|
| 0 | Bootloader Info | UNSIGNED32 | RO | Версия и статус загрузчика |

#### 0x2200 - Подробная информация о микропрограмме

| Sub | Параметр | Тип | Доступ | Описание |
|---|---|---|---|---|
| 0 | Количество записей | UNSIGNED8 | RO | 7 |
| 1-7 | Детали микропрограммы | Различные | RO | Информация о сборке, контрольная сумма и т.д. |

#### 0x2201 - Статус

| Sub | Параметр | Тип | Доступ | По умолчанию | Описание |
|---|---|---|---|---|---|
| 0 | Количество записей | UNSIGNED8 | RO | 4 | - |
| 1 | **Статус калибровки** | UNSIGNED8 | RO | 0 | 0=Не откалибрирован, 1=Откалибрирован |
| 2 | Флаг статуса 2 | UNSIGNED8 | RO | 0 | Дополнительный статус |
| 3 | Флаг статуса 3 | UNSIGNED8 | RO | 0 | Дополнительный статус |
| 4 | Флаг статуса 4 | UNSIGNED8 | RO | 0 | Дополнительный статус |

**Статус калибровки:** Устройство должно быть откалибровано на заводе. Значение 1 указывает на наличие действительных данных калибровки.

#### 0x2202 - Параметры

| Sub | Параметр | Тип | Доступ | Описание |
|---|---|---|---|---|
| 0 | Количество записей | UNSIGNED8 | RO | 10 |
| 1-10 | Параметры конфигурации | Различные | RW | Параметры конфигурации, специфичные для устройства |

#### 0x2300 - Статус модуля DOL278

**DOL278** — это дополнительный модуль расширения SKOV с дополнительными входами-выходами и мониторингом питания 24В.

| Sub | Параметр | Тип | Доступ | Единица | Описание |
|---|---|---|---|---|---|
| 0 | Количество записей | UNSIGNED8 | RO | - | 3 |
| 1 | **DOL78 24V** | UNSIGNED16 | RO | мВ | Напряжение питания 24В |
| 2 | **DOL78 House 1** | UNSIGNED16 | RO | - | Статус зоны 1 |
| 3 | **DOL78 House 2** | UNSIGNED16 | RO | - | Статус зоны 2 |

**Масштабирование напряжения:** Значение в мВ (напр., 24195 = 24.195В)

**Сопоставление PDO:** Может передаваться через TPDO 4 (0x190 + NodeID)

#### 0x2301 - Внутренние измерения

Критические диагностические данные, передаваемые периодически (обычно каждые 15 секунд через TPDO 5).

| Sub | Параметр | Тип | Доступ | Единица | Диапазон | Описание |
|---|---|---|---|---|---|---|
| 0 | Количество записей | UNSIGNED8 | RO | - | - | 3 |
| 1 | **Внутренняя температура** | UNSIGNED16 | RO | °C × 10 | 0-1000 | Внутренняя температура устройства |
| 2 | **Внутреннее 15В** | UNSIGNED16 | RO | мВ | 0-20000 | Напряжение шины 15В |
| 3 | **Внутреннее 24В** | UNSIGNED16 | RO | мВ | 0-30000 | Напряжение шины 24В |
| 4 | **Период сетевого тока** | UNSIGNED16 | RO | мкс | 16666-20000 | Период переменного тока (50/60Гц) |

**Пример декодирования:**

```
Сырые данные: 0x0136 0x3BCE 0x5E83 0x4E20
Декодировано:
  Температура: 0x0136 = 310 → 31.0°C
  Шина 15В: 0x3BCE = 15310 → 15.310В
  Шина 24В: 0x5E83 = 24195 → 24.195В
  Период сети: 0x4E20 = 20000мкс → 50Гц сети
```

#### 0x2302 - Управление TRIAC

Управление фазным сечением для нагрузок переменного тока (нагреватели, диммеры и т.д.).

| Sub | Параметр | Тип | Доступ | Единица | Диапазон | Описание |
|---|---|---|---|---|---|---|
| 0 | Количество записей | UNSIGNED8 | RO | - | - | 3 |
| 1 | **Время включения TRIAC 1** | UNSIGNED16 | RWW | мкс | 0-10000 | Время проведения за полупериод |
| 2 | **Время включения TRIAC 2** | UNSIGNED16 | RWW | мкс | 0-10000 | Время проведения за полупериод |

**Метод управления:** Значение представляет микросекунды проведения за полупериод переменного тока
- 0 = ВЫКЛ (без проведения)
- 10000 = Полная мощность (полное проведение цикла для 50Гц)
- 5000 = ~50% мощности

**Тип доступа:** RWW = Чтение/Запись, значение вступает в силу немедленно (Window Запись)

**Сопоставление PDO:** Управление через RPDO 3 (0x510 + NodeID)

#### 0x2400 - Конфигурация количества дополнительных аналоговых выходов

| Индекс | Параметр | Тип | Доступ | Диапазон | Описание |
|---|---|---|---|---|---|
| 0x2400 | Количество доп. AO | UNSIGNED8 | RW | 0/2/4 | Количество выходов расширения |

**Допустимые значения:**
- **0:** Нет дополнительных аналоговых выходов (только выходы основной платы)
- **2:** Только выходы B-клемм
- **4:** Полное расширение (оба A и B клеммы)

**Примечание:** Должно быть настроено перед входом в операционное состояние.

#### 0x2401 - Конфигурация аналоговых входов

Конфигурирует режим работы каждого канала аналогового входа.

| Sub | Параметр | Тип | Доступ | Диапазон | Описание |
|---|---|---|---|---|---|
| 0 | Количество записей | UNSIGNED8 | RO | - | 7 |
| 1 | **Конфигурация AI 1** | UNSIGNED8 | RW | 0-2 | Выбор типа входа |
| 2 | **Конфигурация AI 2** | UNSIGNED8 | RW | 0-2 | Выбор типа входа |
| 3 | **Конфигурация AI 3** | UNSIGNED8 | RW | 0-2 | Выбор типа входа |
| 4 | **Конфигурация AI 4** | UNSIGNED8 | RW | 0-2 | Выбор типа входа |
| 5 | **Конфигурация AI 5** | UNSIGNED8 | RW | 0-2 | Выбор типа входа |
| 6 | **Конфигурация AI 6** | UNSIGNED8 | RW | 0-2 | Выбор типа входа |
| 7 | **Конфигурация AI 7** | UNSIGNED8 | RW | 0-2 | Выбор типа входа |

**Значения конфигурации:**
- **0 = AI (Аналоговый вход):** Прямое измерение напряжения (0-10В)
- **1 = DOL12:** Датчик температуры SKOV (NTC с таблицей поиска)
- **2 = DI (Цифровой вход):** Обнаружение бинарного состояния

**По умолчанию:** Обычно 0 (режим AI)

---

### Объекты данных процесса (0x6000-0x6FFF)

#### 0x6100 - Цифровые входы

| Sub | Параметр | Тип | Доступ | Описание |
|---|---|---|---|---|
| 0 | Количество записей | UNSIGNED8 | RO | 12 |
| 1 | **Состояние цифровых входов** | UNSIGNED16 | RO | Битовое представление состояния входов (биты 0-11) |
| 2 | **Счетчик 1** | UNSIGNED16 | RO | Счетчик импульсов для DI1 |
| 3 | **Счетчик 2** | UNSIGNED16 | RO | Счетчик импульсов для DI2 |
| 4 | **Счетчик 3** | UNSIGNED16 | RO | Счетчик импульсов для DI3 |
| 5 | **Счетчик 4** | UNSIGNED16 | RO | Счетчик импульсов для DI4 |
| 6 | **Счетчик 5** | UNSIGNED16 | RO | Счетчик импульсов для DI5 |
| 7 | **Счетчик 6** | UNSIGNED16 | RO | Счетчик импульсов для DI6 |
| 8 | **Счетчик 7** | UNSIGNED16 | RO | Счетчик импульсов для DI7 |
| 9 | **Счетчик 8** | UNSIGNED16 | RO | Счетчик импульсов для DI8 |
| 10 | **Счетчик 9** | UNSIGNED16 | RO | Счетчик импульсов для DI9 |
| 11 | **Счетчик 10** | UNSIGNED16 | RO | Счетчик импульсов для DI10 |
| 12 | **Счетчик 11** | UNSIGNED16 | RO | Счетчик импульсов для DI11 |

**Битовое представление (Sub 1 - Состояние цифровых входов):**

```
Бит:    15 14 13 12 | 11 10  9  8 | 7  6  5  4 | 3  2  1  0
        Зарезервировано | DI11-DI8    | DI7-DI4    | DI3-DI0
```

**Пример:**
```
Значение: 0x0805 = 0b0000 1000 0000 0101
           DI11=1, DI2=1, DI0=1 (остальные = 0)
```

**Счетчики:**
- Срабатывание по фронту (по умолчанию восходящий фронт)
- 16-битные счетчики (0-65535, с переполнением)
- Могут быть сброшены через запись SDO
- Используются для расходомеров, анемометров и т.д.

#### 0x6106 - Маска прерывания при любом изменении

| Sub | Параметр | Тип | Доступ | Описание |
|---|---|---|---|---|
| 0 | Количество записей | UNSIGNED8 | RO | 3 |
| 1 | Маска прерывания DI 1 | UNSIGNED8 | RW | Включение обнаружения изменения для DI 0-7 |
| 2 | Маска прерывания DI 2 | UNSIGNED8 | RW | Включение обнаружения изменения для DI 8-11 |

**Использование:** Включение передачи TPDO по событию при изменении состояния определенных цифровых входов.

#### 0x6300 - Выходы реле

| Sub | Параметр | Тип | Доступ | Описание |
|---|---|---|---|---|
| 0 | Количество записей | UNSIGNED8 | RO | 1 |
| 1 | **Состояние реле** | UNSIGNED16 | WO | Битовое управление реле (биты 0-11) |

**Битовое представление:**

```
Бит:    15 14 13 12 | 11 10  9  8 | 7  6  5  4 | 3  2  1  0
        Зарезервировано | R11-R8      | R7-R4      | R3-R0
```

**Управление:**
- Бит = 1: Реле ВКЛ (энергизировано)
- Бит = 0: Реле ВЫКЛ (де-энергизировано)

**Пример:**
```javascript
// Включить реле 0, 1 и 5
const relayValue = (1 << 0) | (1 << 1) | (1 << 5);
// relayValue = 0x0023 = 0b0000 0000 0010 0011
```

**Управление через PDO:** Запись через RPDO 0 (COB-ID 0x210 + NodeID)

**Примечания безопасности:**
- Реле по умолчанию ВЫКЛ при включении питания
- Состояние NMT STOPPED → все реле ВЫКЛ
- Истечение времени ожидания может вызвать состояние безопасности (все ВЫКЛ)

#### 0x6401 - Аналоговые входы

| Sub | Параметр | Тип | Доступ | Единица | Диапазон | Описание |
|---|---|---|---|---|---|---|
| 0 | Количество записей | UNSIGNED8 | RO | - | - | 11 |
| 1 | **Аналоговый вход 1** | UNSIGNED16 | RO | мВ | 0-10000 | Напряжение AI1 |
| 2 | **Аналоговый вход 2** | UNSIGNED16 | RO | мВ | 0-10000 | Напряжение AI2 |
| 3 | **Аналоговый вход 3** | UNSIGNED16 | RO | мВ | 0-10000 | Напряжение AI3 |
| 4 | **Аналоговый вход 4** | UNSIGNED16 | RO | мВ | 0-10000 | Напряжение AI4 |
| 5 | **Аналоговый вход 5** | UNSIGNED16 | RO | мВ | 0-10000 | Напряжение AI5 |
| 6 | **Аналоговый вход 6** | UNSIGNED16 | RO | мВ | 0-10000 | Напряжение AI6 |
| 7 | **Аналоговый вход 7** | UNSIGNED16 | RO | мВ | 0-10000 | Напряжение AI7 |
| 8 | **Аналоговый вход 8** | UNSIGNED16 | RO | мВ | 0-10000 | Напряжение AI8 |
| 9 | **Аналоговый вход 9** | UNSIGNED16 | RO | мВ | 0-10000 | Напряжение AI9 |
| 10 | **Аналоговый вход 10** | UNSIGNED16 | RO | мВ | 0-10000 | Напряжение AI10 |
| 11 | **Аналоговый вход 11** | UNSIGNED16 | RO | мВ | 0-10000 | Напряжение AI11 |

**Масштабирование напряжения:** Все значения в милливольтах
- Значение 5000 = 5.000В
- Значение 8080 = 8.080В

**Зависимость от режима входа:**
- **Режим AI (0x2401:x = 0):** Прямое напряжение (0-10000 мВ)
- **Режим DOL12 (0x2401:x = 1):** Напряжение датчика (1900-8080 мВ типично)
- **Режим DI (0x2401:x = 2):** Бинарный порог (~0 или ~10000 мВ)

**Передача через PDO:**
- AI 1-4 → TPDO 1 (0x1A1 + NodeID) каждые 500 мс
- AI 5-7 → TPDO 2 (0x1C1 + NodeID) каждые 500 мс
- AI 8-11 → TPDO 3 (0x1E1 + NodeID) каждые 500 мс

#### 0x6411 - Аналоговые выходы

| Sub | Параметр | Тип | Доступ | Единица | Диапазон | Описание |
|---|---|---|---|---|---|---|
| 0 | Количество записей | UNSIGNED8 | RO | - | - | 6 |
| 1 | **Аналоговый выход 1** | UNSIGNED16 | RWW | мВ | 0-10000 | Задание напряжения AO1 |
| 2 | **Аналоговый выход 2** | UNSIGNED16 | RWW | мВ | 0-10000 | Задание напряжения AO2 |
| 3 | **Аналоговый выход 3** | UNSIGNED16 | RWW | мВ | 0-10000 | Задание напряжения AO3 |
| 4 | **Аналоговый выход 4** | UNSIGNED16 | RWW | мВ | 0-10000 | Задание напряжения AO4 |
| 5 | **Аналоговый выход 5** | UNSIGNED16 | RWW | мВ | 0-10000 | Задание напряжения AO5 |
| 6 | **Аналоговый выход 6** | UNSIGNED16 | RWW | мВ | 0-10000 | Задание напряжения AO6 |

**Масштабирование напряжения:** Все значения в милливольтах
- Запись 5000 → Выход 5.000В
- Запись 10000 → Выход 10.000В

**Доступность выходов:**
- AO1-AO2: Всегда доступны (основная плата)
- AO3-AO6: Требует 0x2400 = 2 или 4 (платы расширения)

**Управление через PDO:**
- AO1-AO2 → RPDO 1 (0x310 + NodeID)
- AO3-AO6 → RPDO 2 (0x410 + NodeID)

**Значения по умолчанию:** 0 мВ (выходы отключены)

#### 0x6426 - Дельта прерывания аналоговых входов

| Sub | Параметр | Тип | Доступ | Единица | Описание |
|---|---|---|---|---|---|
| 0 | Количество записей | UNSIGNED8 | RO | - | 11 |
| 1-11 | Порог дельты AI | UNSIGNED16 | RW | мВ | Порог изменения для PDO по событию |

**Назначение:** Конфигурирование чувствительности обнаружения изменения для передачи TPDO по событию.

**Пример:**
- Установить 0x6426:01 = 100 (пороговое значение 100мВ)
- AI1 изменяется на ≥100мВ → TPDO 1 передается немедленно
- Предотвращает избыточный трафик PDO при незначительных колебаниях

---

## Коммуникация PDO

### Обзор сопоставления PDO

#### Transmit PDO (Устройство → Мастер)

| TPDO | COB-ID | Период | Содержимое данных | Байты |
|---|---|---|---|---|
| **0** | 0x180+ID | По событию | Состояние цифровых входов (0x6100:01) | 2 |
| **1** | 0x1A0+ID | 500 мс | Значения AI1-AI4 (0x6401:01-04) | 8 |
| **2** | 0x1C0+ID | 500 мс | Значения AI5-AI7 (0x6401:05-07) | 6 |
| **3** | 0x1E0+ID | 500 мс | Значения AI8-AI11 (0x6401:08-11) | 8 |
| **4** | 0x190+ID | По событию | Статус DOL78 (0x2300:01-03) | 6 |
| **5** | 0x290+ID | 15 с | Диагностика (0x2301:01-04) | 8 |
| **6** | 0x390+ID | По событию | Счетчики 1-4 (0x6100:02-05) | 8 |
| **7** | 0x490+ID | По событию | Счетчики 5-7 (0x6100:06-08) | 6 |
| **8** | 0x1A0+ID | По событию | Счетчики 8-11 (0x6100:09-12) | 8 |

#### Receive PDO (Мастер → Устройство)

| RPDO | COB-ID | Содержимое данных | Байты | Управление |
|---|---|---|---|---|
| **0** | 0x210+ID | Состояние реле (0x6300:01) | 2 | Цифровые выходы |
| **1** | 0x310+ID | AO1-AO2 (0x6411:01-02) | 4 | Аналоговые выходы 1-2 |
| **2** | 0x410+ID | AO3-AO6 (0x6411:03-06) | 8 | Аналоговые выходы 3-6 |
| **3** | 0x510+ID | TRIAC 1-2 (0x2302:01-02) | 4 | Управление фазой |

### Кодирование данных PDO

Все многобайтовые значения используют порядок байтов **Little-Endian** (LSB первый).

**Пример: TPDO 1 (Аналоговые входы 1-4)**

```
CAN ID: 0x1A0 + NodeID
Расположение данных:
  Байт 0-1: AI1 (UINT16 LE)
  Байт 2-3: AI2 (UINT16 LE)
  Байт 4-5: AI3 (UINT16 LE)
  Байт 6-7: AI4 (UINT16 LE)

Пример сообщения:
  ID: 0x1A1 (NodeID = 0x01)
  Data: [0x10, 0x00, 0x12, 0x00, 0x08, 0x00, 0x12, 0x00]
  
  Декодировано:
    AI1 = 0x0010 = 16 мВ
    AI2 = 0x0012 = 18 мВ
    AI3 = 0x0008 = 8 мВ
    AI4 = 0x0012 = 18 мВ
```

**Пример: TPDO 5 (Внутренние измерения)**

```
CAN ID: 0x290 + NodeID
Расположение данных:
  Байт 0-1: Внутренняя температура (UINT16 LE, °C × 10)
  Байт 2-3: Внутреннее 15В (UINT16 LE, мВ)
  Байт 4-5: Внутреннее 24В (UINT16 LE, мВ)
  Байт 6-7: Период сетевого тока (UINT16 LE, мкс)

Пример сообщения:
  ID: 0x2A0 (NodeID = 0x10)
  Data: [0x36, 0x01, 0xCE, 0x3B, 0x83, 0x5E, 0x20, 0x4E]
  
  Декодировано:
    Температура = 0x0136 = 310 → 31.0°C
    Шина 15В = 0x3BCE = 15310 → 15.310В
    Шина 24В = 0x5E83 = 24195 → 24.195В
    Период сети = 0x4E20 = 20000 → 20 мс (50Гц)
```

**Пример: RPDO 0 (Управление реле)**

```
CAN ID: 0x210 + NodeID
Расположение данных:
  Байт 0-1: Состояние реле (UINT16 LE, битовое представление)

Команда управления (Включить реле 0, 4, 8):
  ID: 0x211 (NodeID = 0x01)
  Data: [0x11, 0x01]
  
  Двоичное: 0x0111 = 0b0000 0001 0001 0001
    Бит 0 = 1 → Реле 0 ВКЛ
    Бит 4 = 1 → Реле 4 ВКЛ
    Бит 8 = 1 → Реле 8 ВКЛ
```

### Типы передачи PDO

| Значение типа | Описание | Использование |
|---|---|---|
| 0 | Синхронный (ациклический) | Не используется SKOV |
| 1-240 | Синхронный (циклический) | Каждый Nth SYNC |
| 254 | По событию (производитель) | При изменении порога |
| 255 | По событию (устройство) | При любом изменении или циклический |

**Значения по умолчанию SKOV:**
- **Тип 255:** Большинство TPDO (по событию или циклический на основе Event Timer)
- **Время ингибирования:** 100 (= 10 мс минимум между PDO)
- **Event Timer:** 0 (отключено) или определенный период (напр., 500 мс для аналоговых входов)

---

## Протокол аналоговых входов

### Режимы входов

SKOV Main IO поддерживает три режима аналоговых входов на канал, конфигурируемые через 0x2401:

#### Режим 0: Аналоговый вход (AI)

- **Диапазон:** 0-10В DC
- **Разрешение:** 16-бит (0-10000 мВ)
- **Случай использования:** Общее измерение напряжения, датчики 0-10В
- **Кодирование:** Прямое напряжение в милливольтах

**Пример:**
```
Выход датчика: 3.5В
Сырое значение: 3500 (десятичное) = 0x0DAC (шестнадцатеричное)
```

#### Режим 1: Датчик температуры DOL12

- **Диапазон:** -40°C до +100°C
- **Тип датчика:** Собственный NTC термистор SKOV
- **Диапазон напряжения:** 1.90В до 8.08В (инвертированная характеристика)
- **Кодирование:** Напряжение в милливольтах (требует таблицы поиска для температуры)

**См.:** Раздел [Протокол датчика DOL12](#протокол-датчика-dol12) для подробностей конверсии.

#### Режим 2: Цифровой вход (DI)

- **Порог:** ~5В (типично)
- **Логические уровни:**
  - НИЗКИЙ: 0-2В → Значение ≈ 0-2000 мВ
  - ВЫСОКИЙ: 8-10В → Значение ≈ 8000-10000 мВ
- **Случай использования:** Бинарные датчики, переключатели, сухие контакты

**Пример:**
```
Переключатель ЗАМКНУТ → Напряжение ≈ 0В → Значение ≈ 0
Переключатель ОТКРЫТ → Напряжение ≈ 10В → Значение ≈ 10000
```

### Дискретизация аналоговых входов

- **Частота дискретизации:** Обычно 10-100 мс на канал
- **Фильтрация:** Аппаратный низкочастотный фильтр (снижение шума)
- **Обновление PDO:** 500 мс для каналов реального времени (TPDO 1-3)
- **Разрешение:** 16-бит АЦП → 0.15 мВ на LSB для диапазона 0-10В

---

## Протокол цифровых входов-выходов

### Цифровые входы

**Физические характеристики:**
- **Тип:** Оптоизолированные входы (гальваническая развязка)
- **Диапазон напряжения:** 0-24В DC
- **Логические уровни:**
  - НИЗКИЙ: 0-5В
  - ВЫСОКИЙ: 10-30В (24В номинально)
- **Количество:** 12 входов (DI0-DI11)

**Возможности:**
- Отчет о состоянии в реальном времени через TPDO 0
- Счет импульсов (16-битные счетчики на вход)
- Обнаружение фронта (восходящий/нисходящий/оба)
- PDO, управляемый прерыванием

**Режим счетчика:**
- Подсчитывает восходящие фронты (по умолчанию)
- 16-битный счетчик (0-65535, с переполнением)
- Диапазон частоты: DC до нескольких кГц
- Приложения: Расходомеры, датчики ветра, импульсные выходы

**Сопоставление PDO:**
- Состояния → TPDO 0 (0x181 для NodeID=1) - по событию
- Счетчики → TPDO 6/7/8 - при изменении или периодический

### Цифровые выходы (Реле)

**Физические характеристики:**
- **Тип:** Электромеханические реле (SPST)
- **Количество:** 12 выходов + 1 аварийное реле
- **Номинальные характеристики:** Обычно 5А @ 250VAC, 5А @ 30VDC
- **Развязка:** Гальваническая развязка от управляющей схемы

**Управление:**
- Битовое управление через 0x6300:01
- RPDO 0 для управления в реальном времени
- Отдельный бит на реле (бит 0 = реле 0 и т.д.)

**Функции безопасности:**
- Значение по умолчанию при включении: Все ВЫКЛ
- Состояние NMT STOPPED: Все ВЫКЛ
- Истечение времени watchdog: Настраиваемое поведение (типично все ВЫКЛ)
- Аварийная остановка: Все ВЫКЛ через EMCY или команду NMT

**Типичные приложения:**
- **Реле 0-7:** Вентиляторы, нагреватели, сигналы
- **Реле 8-11:** Вспомогательное оборудование, насосы, двигатели
- **Аварийное реле:** Аварийный выход (управляется аппаратно)

---

## Протокол датчика DOL12

### Обзор

**DOL12** — собственный датчик температуры SKOV, использующий NTC (отрицательный температурный коэффициент) термистор с определенной характеристикой напряжение-температура.

**Ключевые характеристики:**
- **Диапазон температуры:** -40°C до +100°C
- **Диапазон напряжения:** 8.08В до 1.90В (уменьшается с повышением температуры)
- **Подключение:** 2-проводное, питается модулем аналогового входа
- **Точность:** Обычно ±0.5°C (при калибровке)

### Таблица поиска напряжение-температура

Датчик DOL12 следует нелинейной характеристике. Конверсия требует таблицы поиска с линейной интерполяцией.

**Выбранные точки калибровки:**

| Температура (°C) | Напряжение (В) | Температура (°C) | Напряжение (В) |
|---|---|---|---|
| -40 | 8.08 | 20 | 4.93 |
| -35 | 7.96 | 25 | 4.57 |
| -30 | 7.83 | 30 | 4.23 |
| -25 | 7.68 | 35 | 3.91 |
| -20 | 7.49 | 40 | 3.61 |
| -15 | 7.26 | 50 | 3.09 |
| -10 | 7.00 | 60 | 2.68 |
| -5 | 6.70 | 70 | 2.36 |
| 0 | 6.37 | 80 | 2.11 |
| 5 | 6.02 | 90 | 1.95 |
| 10 | 5.66 | 100 | 1.90 |
| 15 | 5.29 | - | - |

**Полная таблица:** 66 точек калибровки от -40°C до +100°C (см. `dol12.js` в коде эмулятора)

### Алгоритм конверсии температуры

#### От напряжения к температуре

```javascript
function voltageToTemperature(voltage) {
    // Обработка значений вне диапазона
    if (voltage >= 8.08) return -40.0;  // Ниже минимальной температуры
    if (voltage <= 1.90) return 100.0;  // Выше максимальной температуры
    
    // Поиск граничных точек в таблице поиска
    let lower, upper;
    for (let i = 0; i < lookupTable.length - 1; i++) {
        if (lookupTable[i].voltage >= voltage && 
            lookupTable[i+1].voltage <= voltage) {
            lower = lookupTable[i];
            upper = lookupTable[i+1];
            break;
        }
    }
    
    // Линейная интерполяция
    const tempRange = upper.temp - lower.temp;
    const voltRange = upper.voltage - lower.voltage;
    const voltOffset = voltage - lower.voltage;
    
    return lower.temp + (voltOffset / voltRange) * tempRange;
}
```

#### От температуры к напряжению

```javascript
function temperatureToVoltage(temp) {
    // Обработка значений вне диапазона
    if (temp <= -40) return 8.08;
    if (temp >= 100) return 1.90;
    
    // Поиск граничных точек в таблице поиска
    let lower, upper;
    for (let i = 0; i < lookupTable.length - 1; i++) {
        if (lookupTable[i].temp <= temp && 
            lookupTable[i+1].temp >= temp) {
            lower = lookupTable[i];
            upper = lookupTable[i+1];
            break;
        }
    }
    
    // Линейная интерполяция
    const voltRange = upper.voltage - lower.voltage;
    const tempRange = upper.temp - lower.temp;
    const tempOffset = temp - lower.temp;
    
    return lower.voltage + (tempOffset / tempRange) * voltRange;
}
```

### Интеграция с устройством SKOV

**Конфигурация:**

1. Установить режим входа на DOL12:
```
SDO Write: 0x2401:01 = 1  (Конфигурировать AI1 как DOL12)
```

2. Читать напряжение датчика:
```
SDO Read: 0x6401:01 → Возвращает напряжение в мВ (напр., 5290 = 5.290В)
Или через TPDO 1 (данные в реальном времени)
```

3. Конвертировать в температуру:
```
Напряжение: 5290 мВ = 5.29В
Поиск: 5.29В ≈ 15°C (по таблице DOL12)
```

**Данные PDO:**

Устройство передает **сырое значение напряжения**, не температуру. Конверсия температуры должна быть выполнена мастером/системой SCADA, используя таблицу поиска DOL12.

```
Данные TPDO 1 для NodeID 0x10:
  CAN ID: 0x1A0 + 0x10 = 0x1B0
  Data: [0xAA, 0x14, ...]  // AI1 = 0x14AA = 5290 мВ
  
  Конверсия мастера: 5290 мВ → 5.29В → ~15°C
```

### Типичные случаи использования

- **Птичники:** Мониторинг температуры окружающей среды
- **Свинофермы:** Управление температурой зоны
- **Теплицы:** Мониторинг климата
- **Хранилища:** Мониторинг холодильных камер

---

## Протокол модуля DOL78

### Обзор

**DOL78** (также обозначаемый как DOL278 в EDS) — это дополнительный модуль расширения SKOV, который обеспечивает:
- Дополнительную емкость входов-выходов
- Мониторинг питания 24В
- Возможности управления на основе зон
- Расширенную диагностику

**Коммуникация:** Интегрирована в Main IO через внутреннюю шину, отображается как объект 0x2300 в словаре CANopen.

### Словарь объектов (0x2300)

| Sub | Параметр | Тип | Единица | Описание |
|---|---|---|---|---|
| 1 | DOL78 24V | UINT16 | мВ | Напряжение питания 24В DC |
| 2 | DOL78 House 1 | UINT16 | - | Статус зоны 1 |
| 3 | DOL78 House 2 | UINT16 | - | Статус зоны 2 |

### Мониторинг питания 24В

**Назначение:** Мониторинг здоровья источника питания для предсказательного обслуживания и безопасности.

**Кодирование напряжения:**
```
Сырое значение в мВ
Пример: 24195 = 24.195В

Типичный диапазон: 22000-26000 мВ (22-26В)
Пороги сигнала тревоги:
  - Ниже 20В: Сигнал низкого напряжения
  - Выше 28В: Сигнал высокого напряжения
```

**Передача через PDO:** Через TPDO 4 (0x190 + NodeID), по событию при значительном изменении

**Типичная логика мониторинга:**
```javascript
if (dol78_24v < 22000) {
    // Предупреждение низкого напряжения
    // Проверить источник питания, соединения
}
if (dol78_24v > 26000) {
    // Предупреждение высокого напряжения
    // Риск повреждения оборудования
}
```

### Статус зоны

**Назначение:** Управление по несколькимзонам для больших сельскохозяйственных зданий, разделенных на секции.

**Кодирование данных:** Специфично для приложения, обычно:
- Задание точки температуры
- Этап вентиляции
- Статус сигнала тревоги
- Параметры пользовательского управления

**Пример использования:**
```
Зона 1: Секция молодняка (молодые птицы)
  - Целевая температура: 32°C
  - Значение статуса: Кодировано как UINT16
  
Зона 2: Секция доращивания (более старые птицы)
  - Целевая температура: 22°C
  - Значение статуса: Другое кодирование
```

**Примечание:** Точное кодирование специфично для приложения и конфигурируется через программное обеспечение SKOV.

---

## Последовательность инициализации

### Типичная последовательность загрузки мастера CANopen

Эта последовательность демонстрирует, как устройство SKOV Main IO обычно инициализируется при загрузке мастера CANopen.

#### Этап 1: Обнаружение сети

```
Время: T+0 мс
CAN сообщение: ID=0x000, Data=[0x81, 0x10]
Описание: Команда NMT - Сброс узла (NodeID 0x10)
Эффект: Устройство выполняет мягкий сброс, входит в состояние Pre-operational
```

```
Время: T+50 мс
CAN сообщение: ID=0x710, Data=[0x00]
Описание: Загрузочное сообщение NMT от NodeID 0x10
Эффект: Устройство сигнализирует, что готово к конфигурации
```

#### Этап 2: Идентификация устройства

**Шаг 1: Читать имя устройства**
```
Мастер TX: ID=0x610, Data=[0x40, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00]
  Запрос загрузки SDO: Читать 0x1008 (Имя устройства)
  
Устройство RX: ID=0x590, Data=[0x43, 0x08, 0x10, 0x00, 0x53, 0x4D, 0x30, 0x30]
  Ответ загрузки SDO: Значение = "SM00" (ASCII)
```

**Шаг 2: Читать тип устройства**
```
Мастер TX: ID=0x610, Data=[0x40, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00]
  Запрос загрузки SDO: Читать 0x1000 (Тип устройства)
  
Устройство RX: ID=0x590, Data=[0x43, 0x00, 0x10, 0x00, 0x91, 0x01, 0x0E, 0x00]
  Ответ загрузки SDO: Значение = 0x000E0191
```

**Шаг 3: Читать версию программного обеспечения**
```
Мастер TX: ID=0x610, Data=[0x40, 0x0A, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00]
  Запрос загрузки SDO: Читать 0x100A (Версия ПО)
  
Устройство RX: ID=0x590, Data=[0x43, 0x0A, 0x10, 0x00, 0x35, 0x32, 0x30, 0x32]
  Ответ загрузки SDO: Значение = "5202" (ASCII)
```

**Шаг 4: Читать редакцию оборудования**
```
Мастер TX: ID=0x610, Data=[0x40, 0x18, 0x10, 0x03, 0x00, 0x00, 0x00, 0x00]
  Запрос загрузки SDO: Читать 0x1018:03 (Номер редакции)
  
Устройство RX: ID=0x590, Data=[0x43, 0x18, 0x10, 0x03, 0x1D, 0x00, 0x00, 0x00]
  Ответ загрузки SDO: Значение = 29 (0x1D)
```

**Шаг 5: Читать серийный номер**
```
Мастер TX: ID=0x610, Data=[0x40, 0x18, 0x10, 0x04, 0x00, 0x00, 0x00, 0x00]
  Запрос загрузки SDO: Читать 0x1018:04 (Серийный номер)
  
Устройство RX: ID=0x590, Data=[0x43, 0x18, 0x10, 0x04, 0x04, 0x2C, 0xFC, 0x05]
  Ответ загрузки SDO: Значение = 100412420 (0x05FC2C04)
  
ID устройства: "100412420-29"
```

#### Этап 3: Конфигурация

**Шаг 6: Читать конфигурацию оборудования**
```
Мастер TX: ID=0x610, Data=[0x40, 0x00, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00]
  Запрос загрузки SDO: Читать 0x2400 (Количество доп. AO)
  
Устройство RX: ID=0x590, Data=[0x4F, 0x00, 0x24, 0x00, 0x02, 0x00, 0x00, 0x00]
  Ответ загрузки SDO: Значение = 2 (Только B-клеммы)
```

**Шаг 7: Конфигурировать Guard Time (Опционально)**
```
Мастер TX: ID=0x610, Data=[0x2B, 0x0C, 0x10, 0x00, 0xE8, 0x03, 0x00, 0x00]
  Запрос загрузки SDO: Записать 0x100C = 1000 мс
  
Устройство RX: ID=0x590, Data=[0x60, 0x0C, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00]
  Ответ загрузки SDO: ОК
```

**Шаг 8: Конфигурировать Life Time Factor (Опционально)**
```
Мастер TX: ID=0x610, Data=[0x2F, 0x0D, 0x10, 0x00, 0x05, 0x00, 0x00, 0x00]
  Запрос загрузки SDO: Записать 0x100D = 5
  
Устройство RX: ID=0x590, Data=[0x60, 0x0D, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00]
  Ответ загрузки SDO: ОК
  
Timeout Watchdog = 1000 мс × 5 = 5000 мс
```

**Шаг 9: Проверить статус калибровки**
```
Мастер TX: ID=0x610, Data=[0x40, 0x01, 0x22, 0x01, 0x00, 0x00, 0x00, 0x00]
  Запрос загрузки SDO: Читать 0x2201:01 (Статус калибровки)
  
Устройство RX: ID=0x590, Data=[0x4F, 0x01, 0x22, 0x01, 0x01, 0x00, 0x00, 0x00]
  Ответ загрузки SDO: Значение = 1 (Откалибрировано)
```

#### Этап 4: Вход в операционное состояние

```
Время: T+1000 мс
CAN сообщение: ID=0x000, Data=[0x01, 0x10]
Описание: Команда NMT - Запустить удаленный узел (NodeID 0x10)
Эффект: Устройство входит в состояние Operational, начинается передача PDO
```

```
Время: T+1010 мс
CAN сообщение: ID=0x710, Data=[0x05]
Описание: Heartbeat - Состояние = Operational (0x05)
Эффект: Устройство подтверждает операционное состояние
```

#### Этап 5: Начало передачи PDO

**Первые сообщения PDO (данные реального времени):**

```
Время: T+1020 мс
CAN сообщение: ID=0x181, Data=[0x00]
Описание: TPDO 0 - Все цифровые входы НИЗКИЕ
```

```
Время: T+1050 мс
CAN сообщение: ID=0x1A1, Data=[0x10, 0x00, 0x12, 0x00, 0x08, 0x00, 0x12, 0x00]
Описание: TPDO 1 - Аналоговые входы 1-4
  AI1 = 16 мВ, AI2 = 18 мВ, AI3 = 8 мВ, AI4 = 18 мВ
```

```
Время: T+1070 мс
CAN сообщение: ID=0x1C1, Data=[0x12, 0x00, 0x08, 0x00, 0x19, 0x00, 0x15, 0x00]
Описание: TPDO 2 - Аналоговые входы 5-7
  AI5 = 18 мВ, AI6 = 8 мВ, AI7 = 25 мВ
```

```
Время: T+1090 мс
CAN сообщение: ID=0x1E1, Data=[0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]
Описание: TPDO 3 - Аналоговые входы 8-11 (все нули, не используются)
```

**Периодические PDO (цикл 500 мс):**
- TPDO 1, 2, 3 повторяются каждые 500 мс с обновленными значениями аналоговых входов

**Диагностическое PDO (цикл 15 с):**

```
Время: T+15000 мс
CAN сообщение: ID=0x2A0, Data=[0x36, 0x01, 0xCE, 0x3B, 0x83, 0x5E, 0x20, 0x4E]
Описание: TPDO 5 - Внутренние измерения
  Температура = 31.0°C
  Шина 15В = 15.310В
  Шина 24В = 24.195В
  Период сети = 20000 мкс (50Гц)
```

**Heartbeat (Периодический):**

```
Время: T+2000 мс, T+3000 мс, T+4000 мс...
CAN сообщение: ID=0x710, Data=[0x05] или [0x85]
Описание: Heartbeat переключение (чередуется между 0x05 и 0x85)
```

### Контрольный список конфигурации

Перед входом в операционное состояние убедитесь:

- ✓ Идентификация устройства проверена (Тип устройства, Серийный номер)
- ✓ Версия программного обеспечения совместима с приложением
- ✓ Статус калибровки = 1 (Откалибрировано)
- ✓ Количество доп. AO сконфигурировано правильно
- ✓ Guard time/heartbeat сконфигурированы (если требуется)
- ✓ Параметры коммуникации PDO установлены
- ✓ Режимы аналоговых входов сконфигурированы (AI/DOL12/DI)
- ✓ COB-ID RPDO включены (бит 31 очищен)

---

## Кодирование данных

### Порядок байтов

**Все многобайтовые значения используют кодирование Little-Endian:**
- Наименее значимый байт (LSB) первый
- Наиболее значимый байт (MSB) последний

**Примеры:**

```
16-битное значение: 0x1234
  Байт 0: 0x34 (LSB)
  Байт 1: 0x12 (MSB)
  
32-битное значение: 0x12345678
  Байт 0: 0x78 (LSB)
  Байт 1: 0x56
  Байт 2: 0x34
  Байт 3: 0x12 (MSB)
```

### Кодирование типов данных

| Тип CANopen | Размер | Диапазон | Использование SKOV |
|---|---|---|---|
| UNSIGNED8 | 1 байт | 0-255 | Флаги, состояния, малые счетчики |
| UNSIGNED16 | 2 байта | 0-65535 | Напряжения (мВ), температуры (×10), счетчики |
| UNSIGNED32 | 4 байта | 0-4.29B | ID устройств, серийные номера |
| INTEGER16 | 2 байта | -32768 до +32767 | Знаковые значения (редко используется) |
| STRING | Переменный | ASCII | Имя устройства, версии |

### Масштабирующие коэффициенты

| Параметр | Тип данных | Масштабирование | Диапазон | Пример |
|---|---|---|---|---|
| **Температура** | UINT16 | °C × 10 | 0-1000 | 310 = 31.0°C |
| **Напряжение (мВ)** | UINT16 | мВ | 0-30000 | 24195 = 24.195В |
| **Напряжение (В)** | UINT16 | В × 1000 | 0-30 | 15310 = 15.310В |
| **Время (мкс)** | UINT16 | мкс | 0-65535 | 20000 = 20 мс |
| **Время (мс)** | UINT16 | мс | 0-65535 | 500 = 0.5 с |
| **Процент** | UINT16 | % × 100 | 0-10000 | 7550 = 75.50% |
| **Частота** | UINT16 | Гц × 10 | 0-6553.5 | 500 = 50.0 Гц |

### Кодирование битовых полей

**Цифровые входы (0x6100:01):**
```
Позиция бита: 15 14 13 12 11 10  9  8  7  6  5  4  3  2  1  0
Смысл:        -- -- -- -- DI11-DI8     DI7-DI4     DI3-DI0

Пример: 0x0A05 = 0b0000 1010 0000 0101
  Бит 0 = 1 → DI0 = ВЫСОКИЙ
  Бит 2 = 1 → DI2 = ВЫСОКИЙ
  Бит 9 = 1 → DI9 = ВЫСОКИЙ
  Бит 11 = 1 → DI11 = ВЫСОКИЙ
```

**Выходы реле (0x6300:01):**
```
Позиция бита: 15 14 13 12 11 10  9  8  7  6  5  4  3  2  1  0
Смысл:        -- -- -- --  R11-R8      R7-R4      R3-R0

Пример: 0x0F03 = 0b0000 1111 0000 0011
  Биты 0-1 = 11 → Реле 0-1 ВКЛ
  Биты 8-11 = 1111 → Реле 8-11 ВКЛ
```

### Кодирование SDO

**Ускоренная передача (≤4 байта):**

**Запрос загрузки (Чтение):**
```
Байт 0: 0x40 (Спецификатор команды)
Байт 1: Индекс LSB
Байт 2: Индекс MSB
Байт 3: Подиндекс
Байты 4-7: Зарезервировано (0x00)
```

**Ответ загрузки:**
```
Байт 0: 0x43 (4 байта данных) / 0x47 (3 байта) / 0x4B (2 байта) / 0x4F (1 байт)
Байт 1: Индекс LSB
Байт 2: Индекс MSB
Байт 3: Подиндекс
Байты 4-7: Данные (Little-Endian)
```

**Запрос загрузки (Запись):**
```
Байт 0: 0x23 (4 байта) / 0x27 (3 байта) / 0x2B (2 байта) / 0x2F (1 байт)
Байт 1: Индекс LSB
Байт 2: Индекс MSB
Байт 3: Подиндекс
Байты 4-7: Данные (Little-Endian)
```

**Ответ загрузки:**
```
Байт 0: 0x60 (Успешно)
Байт 1: Индекс LSB
Байт 2: Индекс MSB
Байт 3: Подиндекс
Байты 4-7: Зарезервировано (0x00)
```

**Пример: Читать аналоговый вход 1**
```
Запрос:  [0x40, 0x01, 0x64, 0x01, 0x00, 0x00, 0x00, 0x00]
         Читать 0x6401:01
Ответ:   [0x4B, 0x01, 0x64, 0x01, 0xAA, 0x14, 0x00, 0x00]
         Значение = 0x14AA = 5290 мВ
```

**Пример: Записать состояние реле**
```
Запрос:  [0x2B, 0x00, 0x63, 0x01, 0x07, 0x00, 0x00, 0x00]
         Записать 0x6300:01 = 0x0007 (Реле 0, 1, 2 ВКЛ)
Ответ:   [0x60, 0x00, 0x63, 0x01, 0x00, 0x00, 0x00, 0x00]
         Запись успешна
```

---

## Примеры

### Пример 1: Чтение температуры с датчика DOL12

**Сценарий:** AI1 сконфигурирован как DOL12, читать текущую температуру.

**Шаг 1: Проверить конфигурацию**
```
Загрузка SDO: 0x2401:01
Запрос:  ID=0x610, [0x40, 0x01, 0x24, 0x01, 0x00, 0x00, 0x00, 0x00]
Ответ:   ID=0x590, [0x4F, 0x01, 0x24, 0x01, 0x01, 0x00, 0x00, 0x00]
Результат: Режим AI1 = 1 (DOL12) ✓
```

**Шаг 2: Читать напряжение через SDO**
```
Загрузка SDO: 0x6401:01
Запрос:  ID=0x610, [0x40, 0x01, 0x64, 0x01, 0x00, 0x00, 0x00, 0x00]
Ответ:   ID=0x590, [0x4B, 0x01, 0x64, 0x01, 0xAA, 0x14, 0x00, 0x00]
Результат: Напряжение = 0x14AA = 5290 мВ = 5.29В
```

**Шаг 3: Конвертировать в температуру**
```
Используя таблицу поиска DOL12:
  5.29В находится между:
    5.29В @ 15°C
    5.22В @ 16°C
    
  Линейная интерполяция:
    T = 15°C (ближайшее совпадение)
    
Результат: Температура ≈ 15°C
```

**Альтернатива: Читать через PDO**
```
Получить TPDO 1: ID=0x1A0 + NodeID
Data: [0xAA, 0x14, ...]
      └─ AI1 = 0x14AA = 5290 мВ → 15°C
```

### Пример 2: Управление реле

**Сценарий:** Включить реле 0, 4, 8 и выключить все остальные.

**Шаг 1: Вычислить битовую маску**
```
Желаемое состояние:
  Реле 0: ВКЛ  → Бит 0 = 1
  Реле 4: ВКЛ  → Бит 4 = 1
  Реле 8: ВКЛ  → Бит 8 = 1
  Остальные: ВЫКЛ → Все остальные биты = 0
  
Битовая маска: (1<<0) | (1<<4) | (1<<8) = 0x0111
Двоичное: 0b0000 0001 0001 0001
```

**Шаг 2: Отправить через SDO**
```
Загрузка SDO: 0x6300:01 = 0x0111
Запрос:  ID=0x610, [0x2B, 0x00, 0x63, 0x01, 0x11, 0x01, 0x00, 0x00]
Ответ:   ID=0x590, [0x60, 0x00, 0x63, 0x01, 0x00, 0x00, 0x00, 0x00]
Результат: Реле успешно обновлены
```

**Альтернатива: Отправить через PDO**
```
RPDO 0: ID=0x210 + NodeID = 0x211 (для NodeID=1)
Data: [0x11, 0x01]
Результат: Реле обновлены в реальном времени (<1 мс)
```

### Пример 3: Установка аналогового выхода

**Сценарий:** Установить AO2 на 7.5В (7500 мВ).

**Шаг 1: Вычислить сырое значение**
```
Желаемое напряжение: 7.5В = 7500 мВ
Сырое значение: 7500 (десятичное) = 0x1D4C (шестнадцатеричное)
```

**Шаг 2: Отправить через SDO**
```
Загрузка SDO: 0x6411:02 = 7500
Запрос:  ID=0x610, [0x2B, 0x11, 0x64, 0x02, 0x4C, 0x1D, 0x00, 0x00]
Ответ:   ID=0x590, [0x60, 0x11, 0x64, 0x02, 0x00, 0x00, 0x00, 0x00]
Результат: AO2 установлен на 7.5В
```

**Альтернатива: Отправить через PDO**
```
RPDO 1: ID=0x310 + NodeID = 0x311 (для NodeID=1)
Data: [0x00, 0x00, 0x4C, 0x1D]
      └─ AO1    └─ AO2 = 7500 мВ
Результат: AO2 обновлен, AO1 не изменился (если 0x0000 интерпретируется как "без изменений")
```

**Примечание:** Некоторые реализации требуют отправки всех сопоставленных значений, другие поддерживают выборочные обновления.

### Пример 4: Мониторинг диагностики

**Сценарий:** Непрерывный мониторинг здоровья устройства через TPDO 5.

**Получение PDO:**
```
CAN ID: 0x290 + NodeID = 0x2A0 (для NodeID=0x10)
Период: 15 секунд
Data: [0x36, 0x01, 0xCE, 0x3B, 0x83, 0x5E, 0x20, 0x4E]
```

**Декодирование:**
```javascript
const data = Buffer.from([0x36, 0x01, 0xCE, 0x3B, 0x83, 0x5E, 0x20, 0x4E]);

const internalTemp = data.readUInt16LE(0) / 10;  // 310 / 10 = 31.0°C
const rail15V = data.readUInt16LE(2) / 1000;     // 15310 / 1000 = 15.310В
const rail24V = data.readUInt16LE(4) / 1000;     // 24195 / 1000 = 24.195В
const netPeriod = data.readUInt16LE(6);          // 20000 мкс = 20 мс → 50Гц

console.log(`Температура: ${internalTemp}°C`);
console.log(`Шина 15В: ${rail15V}В`);
console.log(`Шина 24В: ${rail24V}В`);
console.log(`Частота сети: ${1000000/netPeriod}Гц`);
```

**Проверки здоровья:**
```javascript
// Сигнал тревоги температуры
if (internalTemp > 60) {
    console.warn('СИГНАЛ: Высокая внутренняя температура!');
}

// Сигналы тревоги напряжения
if (rail15V < 14.0 || rail15V > 16.0) {
    console.warn('СИГНАЛ: Шина 15В вне спецификации!');
}
if (rail24V < 22.0 || rail24V > 26.0) {
    console.warn('СИГНАЛ: Шина 24В вне спецификации!');
}

// Проверка частоты сети
const mainsFreq = 1000000 / netPeriod;
if (mainsFreq < 48 || mainsFreq > 52) {
    console.warn('СИГНАЛ: Частота сети ненормальна!');
}
```

### Пример 5: Мониторинг цифровых входов по событиям

**Сценарий:** Мониторить дверной переключатель на DI3, вызвать сигнал при изменении состояния.

**Шаг 1: Включить маску прерывания**
```
Загрузка SDO: 0x6106:01 |= (1<<3)  // Включить обнаружение изменения DI3
Запрос:  ID=0x610, [0x2F, 0x06, 0x61, 0x01, 0x08, 0x00, 0x00, 0x00]
Ответ:   ID=0x590, [0x60, 0x06, 0x61, 0x01, 0x00, 0x00, 0x00, 0x00]
```

**Шаг 2: Мониторить TPDO 0**
```
CAN ID: 0x180 + NodeID = 0x181
Передача: По событию (при изменении любого DI)
Data: [0x08, 0x00]  // DI3 = ВЫСОКИЙ (дверь открыта)
      └─ 0x0008 = 0b0000 0000 0000 1000
```

**Шаг 3: Обнаружить изменение состояния**
```javascript
let previousState = 0;

function onTPDO0(data) {
    const currentState = data.readUInt16LE(0);
    const di3 = (currentState >> 3) & 1;
    
    if (di3 !== ((previousState >> 3) & 1)) {
        if (di3 === 1) {
            console.log('СИГНАЛ: Дверь открыта!');
            // Вызвать аварийное реле
            setRelayState(12, true); // Реле 12 = сигнал
        } else {
            console.log('ИНФ: Дверь закрыта.');
            setRelayState(12, false);
        }
    }
    
    previousState = currentState;
}
```

### Пример 6: Управление TRIAC фазовой регулировкой

**Сценарий:** Управлять мощностью нагревателя на 60% с использованием TRIAC 1.

**Шаг 1: Вычислить время включения**
```
Цикл переменного тока: 50Гц → Период = 20 мс = 20000 мкс
Полупериод: 10 мс = 10000 мкс
Желаемая мощность: 60%
Время включения: 10000 мкс × 0.60 = 6000 мкс
```

**Шаг 2: Установить время включения TRIAC 1**
```
Загрузка SDO: 0x2302:01 = 6000
Запрос:  ID=0x610, [0x2B, 0x02, 0x23, 0x01, 0x70, 0x17, 0x00, 0x00]
Ответ:   ID=0x590, [0x60, 0x02, 0x23, 0x01, 0x00, 0x00, 0x00, 0x00]
Результат: Нагреватель теперь работает на ~60% мощности
```

**Альтернатива: Управление через PDO**
```
RPDO 3: ID=0x510 + NodeID = 0x511
Data: [0x70, 0x17, 0x00, 0x00]
      └─ TRIAC1  └─ TRIAC2
Результат: TRIAC1 = 6000 мкс, TRIAC2 = 0 (выключен)
```

**Кривая мощности (50Гц):**
```
Время включения (мкс) → Приблизительная мощность
0                    → 0%
2500                 → 25%
5000                 → 50%
7500                 → 75%
10000                → 100%
```

---

## Приложения

### A. Сводка COB-ID (NodeID = 0x10)

| Функция | COB-ID | Направление | Данные |
|---|---|---|---|
| NMT | 0x000 | Мастер → Все | Команды NMT |
| SYNC | 0x080 | Мастер → Все | Синхронизация |
| EMCY | 0x090 | Устройство → Мастер | Аварийное |
| TPDO 0 | 0x190 | Устройство → Мастер | Цифровые входы |
| TPDO 1 | 0x1B0 | Устройство → Мастер | AI 1-4 |
| TPDO 2 | 0x1D0 | Устройство → Мастер | AI 5-7 |
| TPDO 3 | 0x1F0 | Устройство → Мастер | AI 8-11 |
| TPDO 4 | 0x1A0 | Устройство → Мастер | Статус DOL78 |
| TPDO 5 | 0x2A0 | Устройство → Мастер | Диагностика |
| TPDO 6 | 0x3A0 | Устройство → Мастер | Счетчики 1-4 |
| TPDO 7 | 0x4A0 | Устройство → Мастер | Счетчики 5-7 |
| TPDO 8 | 0x1B0 | Устройство → Мастер | Счетчики 8-11 |
| RPDO 0 | 0x220 | Мастер → Устройство | Управление реле |
| RPDO 1 | 0x320 | Мастер → Устройство | AO 1-2 |
| RPDO 2 | 0x420 | Мастер → Устройство | AO 3-6 |
| RPDO 3 | 0x520 | Мастер → Устройство | Управление TRIAC 1-2 |
| SDO RX | 0x610 | Мастер → Устройство | Запросы SDO |
| SDO TX | 0x590 | Устройство → Мастер | Ответы SDO |
| Heartbeat | 0x710 | Устройство → Мастер | Heartbeat NMT |

### B. Распространенные коды ошибок

| Код ошибки | Имя | Описание | Типичная причина |
|---|---|---|---|
| 0x05030000 | Ошибка бита переключения | Несоответствие бита переключения SDO | Ошибка сегментированной передачи |
| 0x05040000 | Timeout SDO | Timeout клиента/сервера | Потеря связи |
| 0x05040001 | Неверная команда | Неизвестная команда SDO | Ошибка протокола |
| 0x06010000 | Неподдерживаемый доступ | Объект недоступен | Неправильный режим доступа |
| 0x06010001 | Объект только для записи | Попытка чтения объекта WO | Ошибка протокола |
| 0x06010002 | Объект только для чтения | Попытка записи объекта RO | Ошибка конфигурации |
| 0x06020000 | Объект не существует | Объект отсутствует в словаре | Неверный индекс |
| 0x06040041 | Объект слишком большой | Данные превышают размер PDO | Ошибка сопоставления |
| 0x06040042 | Сбой сопоставления объекта | Сопоставление PDO неверно | Ошибка конфигурации |
| 0x06070010 | Несоответствие типа | Тип данных неверен | Ошибка протокола |
| 0x06070012 | Ошибка длины | Длина данных не соответствует | Ошибка протокола |
| 0x06090011 | Подиндекс не существует | Подиндекс отсутствует в объекте | Неверный подиндекс |
| 0x06090030 | Ошибка диапазона значения | Значение вне пределов | Ошибка проверки данных |
| 0x06090031 | Значение слишком высокое | Значение выше максимума | Ошибка проверки данных |
| 0x06090032 | Значение слишком низкое | Значение ниже минимума | Ошибка проверки данных |
| 0x08000000 | Общая ошибка | Неопределенная ошибка устройства | Различные |
| 0x08000020 | Ошибка данных | Обнаружены неверные данные | Ошибка CRC/четности |
| 0x08000021 | Ошибка сохранения | Запись в флэш-память не удалась | Ошибка оборудования |
| 0x08000022 | Локальная ошибка | Ошибка, специфичная для устройства | Калибровка и т.д. |

### C. Сокращения

| Сокращение | Полный термин |
|---|---|
| AI | Аналоговый вход |
| AO | Аналоговый выход |
| CAN | Контроллерная сетевая шина |
| CiA | CAN in Automation |
| COB-ID | Идентификатор объекта коммуникации |
| DI | Цифровой вход |
| DO | Цифровой выход |
| DOL | SKOV Device OnLine (серия датчиков) |
| EDS | Лист электронных данных |
| EMCY | Аварийное |
| LSB | Наименее значимый байт |
| LSS | Услуги установки слоя |
| MSB | Наиболее значимый байт |
| NMT | Управление сетью |
| NTC | Отрицательный температурный коэффициент (термистор) |
| OD | Словарь объектов |
| PDO | Объект данных процесса |
| RPDO | Receive PDO |
| RW | Чтение/Запись |
| RWW | Чтение/Запись/Write-Window (немедленный эффект) |
| RO | Только чтение |
| SDO | Объект данных сервиса |
| TPDO | Transmit PDO |
| WO | Только запись |

### D. Ссылки

1. **CiA 301** - CANopen Application Layer and Communication Profile v4.2.0
2. **CiA 305** - Layer Setting Services and Protocol (LSS) v3.0.0
3. **CiA 306** - Electronic Data Sheet Specification for CANopen v4.1.0
4. **ISO 11898-1** - Controller Area Network (CAN) - Data Link Layer
5. **SKOV Main IO Hardware Manual** - Документация по конкретному продукту
6. **SKOV DOL12 Sensor Datasheet** - Спецификация датчика температуры

### E. История версий документа

| Версия | Дата | Автор | Изменения |
|---|---|---|---|
| 1.0 | 2025-11-12 | Команда разработки | Первоначальный выпуск |

---

**Конец документа**

